pipeline {
    agent {
        label "master"
    }
    parameters {
        booleanParam(name: "OVERWRITE", defaultValue: false, description: "If true all existing keys will be overwritten.")
    }
    stages {
        stage ("Check for existing keys") {
            steps {
                script {
                    if (params.OVERWRITE == false) {
                        SSH_KEYS_EXIST = sh(script: "test ! -f /root/.ssh/id_ed25519.pub && test ! -f /root/.ssh/id_ed25519", returnStatus: true)
                        if (SSH_KEYS_EXIST) {
                            unstable("Keys are already available in /root/.ssh. If you want to generate new pair force creation with OVERWRITE option.")
                        }
                    }
                }
            }
        }
        stage ("Generate ssh keys") {
            steps {
                script {
                    sh "ssh-keygen -t id_ed25519 -N "" -f /root/.ssh/id_ed25519"
                }
            }
        }
    }
}